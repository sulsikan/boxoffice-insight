{% extends 'base.html' %} {% load static %} {% block content %}
<div class="container-fluid mt-4">
  <h2>ì§€ì—­ë³„ ë°•ìŠ¤ì˜¤í”¼ìŠ¤ ë¶„ì„</h2>

  <!-- ğŸ” ê²€ìƒ‰ì°½ -->
  <div class="row mb-4">
    <div class="col-md-6">
      <form id="searchForm" class="d-flex">
        <input
          type="text"
          class="form-control me-2"
          id="movieSearchInput"
          placeholder="ì˜í™” ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
        />
        <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
      </form>
    </div>
  </div>

  <div class="row">
    <!-- ğŸ§­ ì§€ì—­ í•„í„° -->
    <div class="col-md-3">
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">ì§€ì—­ ì„ íƒ</h5>
          <select id="regionSelector" class="form-select">
            <option value="">ì „ì²´</option>
            <option value="seoul">ì„œìš¸ì‹œ</option>
            <option value="gyeonggi">ê²½ê¸°ë„</option>
            <option value="busan">ë¶€ì‚°ì‹œ</option>
            <option value="daegu">ëŒ€êµ¬ì‹œ</option>
            <option value="incheon">ì¸ì²œì‹œ</option>
            <option value="gwangju">ê´‘ì£¼ì‹œ</option>
            <option value="daejeon">ëŒ€ì „ì‹œ</option>
            <option value="ulsan">ìš¸ì‚°ì‹œ</option>
            <option value="sejong">ì„¸ì¢…ì‹œ</option>
            <option value="gangwon">ê°•ì›ë„</option>
            <option value="chungbuk">ì¶©ì²­ë¶ë„</option>
            <option value="chungnam">ì¶©ì²­ë‚¨ë„</option>
            <option value="jeonbuk">ì „ë¼ë¶ë„</option>
            <option value="jeonnam">ì „ë¼ë‚¨ë„</option>
            <option value="gyeongbuk">ê²½ìƒë¶ë„</option>
            <option value="gyeongnam">ê²½ìƒë‚¨ë„</option>
            <option value="jeju">ì œì£¼ë„</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ğŸ“Š íŒŒì´ì°¨íŠ¸ -->
    <div class="col-md-9">
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">ì§€ì—­ë³„ ë§¤ì¶œì ìœ ìœ¨</h5>
          <div id="pieChart" style="height: 400px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸŒ© ì›Œë“œí´ë¼ìš°ë“œ -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">ì§€ì—­ë³„ ë§¤ì¶œ ìƒìœ„ ì˜í™”</h5>
          <div id="wordCloud" style="width: 100%; height: 500px"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.1/wordcloud2.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ğŸ¯ ì˜í™” ê²€ìƒ‰ ì´ë²¤íŠ¸
    document
      .getElementById("searchForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const query = document.getElementById("movieSearchInput").value.trim();
        if (query) {
          fetch(`/api/movie_stats/?title=${encodeURIComponent(query)}`)
            .then((res) => res.json())
            .then((data) => {
              drawPieChart(data.pie_data);
            });
        }
      });

    // ğŸ¯ ì§€ì—­ ì„ íƒ ì´ë²¤íŠ¸
    document
      .getElementById("regionSelector")
      .addEventListener("change", function () {
        const region = this.value;
        fetch(`/api/top_movies_by_region/?region=${region}`)
          .then((res) => res.json())
          .then((data) => {
            drawWordCloud(data.wordcloud_data);
          });
      });

    // ğŸ“Š íŒŒì´ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    function drawPieChart(data) {
      const layout = {
        title: "í•œêµ­ vs ì™¸êµ­ ë§¤ì¶œ ë¹„ìœ¨",
        height: 400,
      };
      Plotly.newPlot("pieChart", [data], layout);
    }

    // â˜ï¸ ì›Œë“œí´ë¼ìš°ë“œ ê·¸ë¦¬ê¸°
    function drawWordCloud(words) {
      WordCloud(document.getElementById("wordCloud"), {
        list: words.map((w) => [w.text, w.value]),
        gridSize: 18,
        weightFactor: 2,
        fontFamily: "Segoe UI",
        color: "#435ebe",
        backgroundColor: "#fff",
      });
    }

    // ìµœì´ˆ ê¸°ë³¸ í˜¸ì¶œ
    document.getElementById("searchForm").dispatchEvent(new Event("submit"));
    document
      .getElementById("regionSelector")
      .dispatchEvent(new Event("change"));
  });
</script>
{% endblock %}
