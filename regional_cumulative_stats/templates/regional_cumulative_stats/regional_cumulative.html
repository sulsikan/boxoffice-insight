{% extends 'base.html' %} {% load static %} {% block content %}
<div class="container mt-4">

  <!-- ì§€ì—­ë³„ ëˆ„ì ë§¤ì¶œì•¡ íŒŒì´ì°¨íŠ¸ -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">ì˜í™”ì˜ ì§€ì—­ë³„ ëˆ„ì  ë§¤ì¶œ ì ìœ ìœ¨</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <!-- ì˜í™” ê²€ìƒ‰ ì„¹ì…˜ -->
              <div class="mt-4 mb-5 text-center">
                <form id="movieSearchForm" class="d-flex justify-content-center" style="gap: 0.5rem;">
                  <input
                    type="text"
                    class="form-control text-center"
                    style="width: 400px;"
                    id="movieSearchInput"
                    placeholder="ì˜í™” ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                    value=""
                  />
                  <button type="submit" class="btn btn-primary w-auto px-4">ê²€ìƒ‰</button>
                </form>
              </div>
              <div id="pieChart" style="width: 100%; height: 500px; margin-top: 6rem; display: flex; justify-content: center; align-items: center;"></div>
            </div>
            <div class="col-md-4">
              <div class="table-responsive">
                <table class="table table-striped text-center">
                  <thead>
                    <tr>
                      <th>ì§€ì—­</th>
                      <th>ëˆ„ì ë§¤ì¶œì•¡</th>
                      <th>ëˆ„ì ê´€ê°ìˆ˜</th>
                    </tr>
                  </thead>
                  <tbody id="statsTable">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì§€ì—­ë³„ ìƒìœ„ ì˜í™” ì›Œë“œí´ë¼ìš°ë“œ -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h4 class="mb-0">ì§€ì—­ë³„ ìƒìœ„ í¥í–‰ ì˜í™” TOP 20</h4>
        </div>
        <div class="card-body">
          <!-- ì§€ì—­ ì„ íƒ ë²„íŠ¼ -->
          <div class="mt-4 d-flex flex-column align-items-center mb-4" id="regionButtons">
            <div class="d-flex flex-wrap gap-2 justify-content-center mb-2">
              <button class="btn btn-outline-success btn-lg" data-region="ì„œìš¸ì‹œ">ì„œìš¸ì‹œ</button>
              <button class="btn btn-outline-success btn-lg" data-region="ê²½ê¸°ë„">ê²½ê¸°ë„</button>
              <button class="btn btn-outline-success btn-lg" data-region="ë¶€ì‚°ì‹œ">ë¶€ì‚°ì‹œ</button>
              <button class="btn btn-outline-success btn-lg" data-region="ëŒ€êµ¬ì‹œ">ëŒ€êµ¬ì‹œ</button>
              <button class="btn btn-outline-success btn-lg" data-region="ì¸ì²œì‹œ">ì¸ì²œì‹œ</button>
              <button class="btn btn-outline-success btn-lg" data-region="ê´‘ì£¼ì‹œ">ê´‘ì£¼ì‹œ</button>
              <button class="btn btn-outline-success btn-lg" data-region="ëŒ€ì „ì‹œ">ëŒ€ì „ì‹œ</button>
              <button class="btn btn-outline-success btn-lg" data-region="ìš¸ì‚°ì‹œ">ìš¸ì‚°ì‹œ</button>
              <button class="btn btn-outline-success btn-lg" data-region="ì„¸ì¢…ì‹œ">ì„¸ì¢…ì‹œ</button>
            </div>
            <div class="d-flex flex-wrap gap-2 justify-content-center">
              <button class="btn btn-outline-success btn-lg" data-region="ê°•ì›ë„">ê°•ì›ë„</button>
              <button class="btn btn-outline-success btn-lg" data-region="ì¶©ì²­ë¶ë„">ì¶©ì²­ë¶ë„</button>
              <button class="btn btn-outline-success btn-lg" data-region="ì¶©ì²­ë‚¨ë„">ì¶©ì²­ë‚¨ë„</button>
              <button class="btn btn-outline-success btn-lg" data-region="ì „ë¼ë¶ë„">ì „ë¼ë¶ë„</button>
              <button class="btn btn-outline-success btn-lg" data-region="ì „ë¼ë‚¨ë„">ì „ë¼ë‚¨ë„</button>
              <button class="btn btn-outline-success btn-lg" data-region="ê²½ìƒë¶ë„">ê²½ìƒë¶ë„</button>
              <button class="btn btn-outline-success btn-lg" data-region="ê²½ìƒë‚¨ë„">ê²½ìƒë‚¨ë„</button>
              <button class="btn btn-outline-success btn-lg" data-region="ì œì£¼ë„">ì œì£¼ë„</button>
            </div>
          </div>
          <div id="wordCloud" style="width: 100%; height: 500px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.1/wordcloud2.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ì´ˆê¸° ë°ì´í„° í‘œì‹œ
    const initialPieData = JSON.parse('{{ initial_pie_data|escapejs }}');
    const initialTableData = JSON.parse('{{ initial_table_data|escapejs }}');
    
    Plotly.newPlot("pieChart", [initialPieData], {
      height: 500,
      margin: { t: 0, b: 0, l: 0, r: 0 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      textinfo: 'label+percent',
      textposition: 'inside',
      insidetextorientation: 'radial',
      texttemplate: '%{label}<br>%{percent:.1%}',
      hovertemplate: '%{label}<br>%{percent:.1%}<br>ë§¤ì¶œì•¡: %{value:,.0f}ì›<extra></extra>',
      textfont: {
        size: 16
      },
      outsidetextfont: {
        size: 16
      },
      automargin: true,
      showlegend: false
    });

    const tbody = document.getElementById("statsTable");
    tbody.innerHTML = initialTableData.map(item => `
      <tr>
        <td>${item.region}</td>
        <td>${item.sales}ì›</td>
        <td>${item.audience}ëª…</td>
      </tr>
    `).join('');

    // ì˜í™” ê²€ìƒ‰ ì´ë²¤íŠ¸
    document
      .getElementById("movieSearchForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const title = document.getElementById("movieSearchInput").value.trim();
        if (title) {
          fetch(`/regional_cumulative_stats/api/movie_stats/?title=${encodeURIComponent(title)}`)
            .then((res) => res.json())
            .then((data) => {
              if (data.pie_data) {
                // 3.5% ë¯¸ë§Œì¸ í•­ëª©ë“¤ì€ í…ìŠ¤íŠ¸ í‘œì‹œë¥¼ ìˆ¨ê¹€
                const values = data.pie_data.values;
                const total = values.reduce((a, b) => a + b, 0);
                const percentages = values.map(v => (v / total) * 100);
                
                const textpositions = percentages.map(p => p < 3.5 ? 'none' : 'inside');
                const texttemplates = percentages.map(p => p < 3.5 ? '' : '%{label}<br>%{percent:.1%}');
                
                Plotly.newPlot("pieChart", [{
                  ...data.pie_data,
                  textposition: textpositions,
                  texttemplate: texttemplates,
                  hovertemplate: '%{label}<br>%{percent:.1%}<br>ë§¤ì¶œì•¡: %{value:,.0f}ì›<extra></extra>'
                }], {
                  height: 500,
                  margin: { t: 0, b: 0, l: 0, r: 0 },
                  paper_bgcolor: 'rgba(0,0,0,0)',
                  plot_bgcolor: 'rgba(0,0,0,0)',
                  textfont: {
                    size: 20
                  },
                  outsidetextfont: {
                    size: 20
                  },
                  automargin: true,
                  showlegend: false
                });
              }
              if (data.table_data) {
                const tbody = document.getElementById("statsTable");
                tbody.innerHTML = data.table_data.map(item => `
                  <tr>
                    <td>${item.region}</td>
                    <td>${item.sales}ì›</td>
                    <td>${item.audience}ëª…</td>
                  </tr>
                `).join('');
              }
            })
            .catch((error) => console.error("Error:", error));
        }
      });

    // ì›Œë“œí´ë¼ìš°ë“œ ì´ˆê¸°í™”
    function initializeWordCloud() {
      const defaultRegion = "ì„œìš¸ì‹œ";
      fetch(`/regional_cumulative_stats/api/top_movies_by_region/?region=${encodeURIComponent(defaultRegion)}`)
        .then((res) => res.json())
        .then((data) => {
          if (data.wordcloud_data) {
            // ê¸°ì¡´ ì›Œë“œí´ë¼ìš°ë“œ ì œê±°
            const wordCloudElement = document.getElementById("wordCloud");
            wordCloudElement.innerHTML = '';
            
            // ìƒˆë¡œìš´ ì›Œë“œí´ë¼ìš°ë“œ ìƒì„±
            WordCloud(wordCloudElement, {
            list: data.wordcloud_data.map((item) => [item.text, item.value]),
            gridSize: 18,
            weightFactor: 0.4,
            minSize: 10,
            maxSize: 50,
            fontFamily: "BobaesumJindo",
            color: function () {
              return `hsl(${Math.random() * 360}, 80%, 50%)`;  // ğŸ¨ ëœë¤ ì»¬ëŸ¬!
            },
            backgroundColor: "#fff",
            rotateRatio: 0,
          });
          }
        })
        .catch((error) => console.error("Error:", error));
    }

    // ì§€ì—­ ë²„íŠ¼ ì´ë²¤íŠ¸
    document
      .getElementById("regionButtons")
      .addEventListener("click", function (e) {
        if (e.target.tagName === "BUTTON") {
          const region = e.target.dataset.region;
          // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
          document
            .querySelectorAll("#regionButtons button")
            .forEach((btn) => {
              btn.classList.remove("active");
            });
          // í´ë¦­ëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
          e.target.classList.add("active");

          fetch(`/regional_cumulative_stats/api/top_movies_by_region/?region=${encodeURIComponent(region)}`)
            .then((res) => res.json())
            .then((data) => {
              if (data.wordcloud_data) {
                // ê¸°ì¡´ ì›Œë“œí´ë¼ìš°ë“œ ì œê±°
                const wordCloudElement = document.getElementById("wordCloud");
                wordCloudElement.innerHTML = '';
                
                // ìƒˆë¡œìš´ ì›Œë“œí´ë¼ìš°ë“œ ìƒì„±
                WordCloud(wordCloudElement, {
                  list: data.wordcloud_data.map((item) => [item.text, item.value]),
                  gridSize: 18,
                  weightFactor: 0.4,
                  minSize: 10,
                  maxSize: 30,
                  fontFamily: "BobaesumJindo",
                  color: function () {
                    return `hsl(${Math.random() * 360}, 60%, 50%)`;
                  },
                  backgroundColor: "#fff",
                  rotateRatio: 0,
                });
              }
            })
            .catch((error) => console.error("Error:", error));
        }
      });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì›Œë“œí´ë¼ìš°ë“œ ì´ˆê¸°í™”
    initializeWordCloud();
  });
</script>
{% endblock %}
